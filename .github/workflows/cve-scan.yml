name: CVE Scan

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  push:
    branches: [main]
    paths:
      - 'pyproject.toml'
      - 'requirements*.txt'
  workflow_dispatch:

jobs:
  scan-python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Install dependencies
        run: pip install -e .

      - name: Run pip-audit
        run: pip-audit --strict --desc on --format json --output pip-audit.json
        continue-on-error: true

      - name: Upload pip-audit results
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-results
          path: pip-audit.json
        if: always()

  scan-docker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          push: false
          load: true
          tags: kage:scan

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'kage:scan'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        if: always()

  scan-dependencies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
        continue-on-error: true

  create-issue-on-vulnerability:
    runs-on: ubuntu-latest
    needs: [scan-python, scan-docker]
    if: failure()
    permissions:
      issues: write
    steps:
      - name: Create issue for vulnerabilities
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Security: Vulnerabilities detected (${new Date().toISOString().split('T')[0]})`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,automated'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.startsWith('Security: Vulnerabilities detected')
            );

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: `## Security Scan Alert

            The automated security scan has detected potential vulnerabilities.

            **Workflow Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            Please review the scan results and update dependencies as needed.

            ### Next Steps
            1. Review the scan artifacts
            2. Update vulnerable dependencies
            3. Re-run the security scan
            4. Close this issue when resolved
            `,
                labels: ['security', 'automated']
              });
            }
